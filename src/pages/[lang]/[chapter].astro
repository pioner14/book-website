---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { useTranslations } from '../../i18n/utils';

// Генерируем пути для всех глав: /ru/chapter1, /ua/chapter2 и т.д.
export async function getStaticPaths() {
  // Получаем все главы
  const allChapters = await getCollection('book');
  return allChapters.map(entry => {
    // В Astro 5 id - это путь к файлу. Извлекаем язык и имя файла без расширения.
    const parts = entry.id.split('/');
    const lang = parts[0];
    const slug = parts[parts.length - 1].replace(/\.mdx$/, '').replace(/\.md$/, '');
    
    return {
      params: { lang, chapter: slug },
      props: { entry },
    };
  });
}

interface Props {
  entry: any; // Тип из getCollection
}

const { entry } = Astro.props;
const { lang } = Astro.params;

// Получаем переводы
const t = useTranslations(lang as 'ru' | 'ua' | 'fr');

// Получаем все главы для фильтрации
const allChapters = await getCollection('book');

// Фильтруем главы для текущего языка
const langChapters = allChapters
  .filter(ch => ch.id.startsWith(lang + '/'))
  .sort((a, b) => a.data.order - b.data.order);

// Функция для получения слага из ID (Astro 5)
const getSlugFromId = (id: string) => {
  const parts = id.split('/');
  return parts[parts.length - 1].replace(/\.mdx$/, '').replace(/\.md$/, '');
};

// Находим текущую главу и соседние
const currentIndex = langChapters.findIndex(ch => ch.id === entry.id);
const prevChapter = currentIndex > 0 ? langChapters[currentIndex - 1] : null;
const nextChapter = currentIndex < langChapters.length - 1 ? langChapters[currentIndex + 1] : null;

// Заголовок страницы
const pageTitle = entry.data.title;

// Описание страницы
const description = entry.data.description || `${t('chapter.label')} ${entry.data.order}: ${entry.data.title}`;

// Рендерим контент
const { Content } = await entry.render();
---

<Layout title={pageTitle} description={description} currentSlug={getSlugFromId(entry.id)}>
  <article class="prose prose-lg prose-headings:text-ink prose-headings:font-serif prose-p:text-ink prose-p:leading-relaxed prose-a:text-primary hover:prose-a:text-primary/80 reader-container" lang={lang}>
    <header class="mb-8 text-center">
      <h1 class="text-3xl font-heading font-bold mb-4 text-ink tracking-wide">{entry.data.title}</h1>
      {entry.data.description && (
        <p class="text-lg text-secondary">{entry.data.description}</p>
      )}
    </header>

    <!-- Контент главы -->
    <Content />

    <!-- Навигация между главами -->
    <nav class="flex justify-between items-center mt-12 pt-8 border-t border-ink/20">
      {prevChapter ? (
        <a href={`/${lang}/${getSlugFromId(prevChapter.id)}`} class="bg-amber-500 hover:bg-amber-600 text-white !text-white font-medium py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          <span class="flex-1 text-center">{t('chapter.label')} {prevChapter.data.order}</span>
        </a>
      ) : (
        <div></div> <!-- Пустой элемент для выравнивания -->
      )}

      <a href={`/${lang}`} class="bg-blue-500 hover:bg-blue-600 text-white !text-white font-medium py-2 px-4 rounded-lg transition-colors duration-300 text-center">
        {t('navigation.back_to_toc')}
      </a>

      {nextChapter ? (
        <a href={`/${lang}/${getSlugFromId(nextChapter.id)}`} class="bg-amber-500 hover:bg-amber-600 text-white !text-white font-medium py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
          <span class="flex-1 text-center">{t('chapter.label')} {nextChapter.data.order}</span>
          <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
      ) : (
        <div></div> <!-- Пустой элемент для выравнивания -->
      )}
    </nav>
  </article>
</Layout>