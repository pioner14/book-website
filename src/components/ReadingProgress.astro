---
// –≠—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ,
// –≤—Å—è –µ–≥–æ –º–∞–≥–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞.
---

<script is:inline>
    const BOOKMARKS_KEY = 'book-bookmarks';

    class ReadingProgress {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≥–ª–∞–≤—ã
        isOnChapterPage = document.querySelector('article.prose') !== null;

        constructor() {
            if (this.isOnChapterPage) {
                this.initTracker();
            } else {
                this.initDisplay();
            }
        }

        // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≥–ª–∞–≤—ã
        initTracker() {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É, –µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            this.restoreScrollPosition();

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            let scrollTimeout;
            document.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = window.setTimeout(() => {
                    this.saveCurrentPosition();
                }, 100); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ —á–∞—â–µ, —á–µ–º —Ä–∞–∑ –≤ 100 –º—Å
            }, { passive: true });

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–∫–ª–∞–¥–∫–∏
            this.addBookmarkButton();
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        restoreScrollPosition() {
            const bookmarks = this.getBookmarks();
            const currentPageBookmark = bookmarks[window.location.pathname];

            if (currentPageBookmark && currentPageBookmark.scroll) {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ–ª–∞ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è
                setTimeout(() => window.scrollTo(0, currentPageBookmark.scroll), 100);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
        saveCurrentPosition() {
            const bookmarks = this.getBookmarks();
            const currentPath = window.location.pathname;

            bookmarks[currentPath] = {
                path: currentPath,
                scroll: window.scrollY,
                title: document.querySelector('h1')?.innerText || '...',
                timestamp: Date.now()
            };

            localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarks));
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–∫–ª–∞–¥–æ–∫
        getBookmarks() {
            try {
                return JSON.parse(localStorage.getItem(BOOKMARKS_KEY)) || {};
            } catch (e) {
                console.error('Error parsing bookmarks from localStorage', e);
                return {};
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫–ª–∞–¥–∫–∏
        addBookmarkButton() {
            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫–ª–∞–¥–∫–∏
            const bookmarkBtn = document.createElement('button');
            bookmarkBtn.innerHTML = 'üîñ';
            bookmarkBtn.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é';
            bookmarkBtn.className = 'fixed bottom-4 right-4 bg-accent text-white p-3 rounded-full shadow-lg hover:bg-primary cursor-pointer z-50';
            bookmarkBtn.style.cssText = 'font-size: 1.5em; border: none;';

            bookmarkBtn.addEventListener('click', () => {
                this.saveCurrentPosition();
                // –ö—Ä–∞—Ç–∫–∞—è –≤–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                const originalText = bookmarkBtn.innerHTML;
                bookmarkBtn.innerHTML = '‚úÖ';
                setTimeout(() => {
                    bookmarkBtn.innerHTML = originalText;
                }, 1000);
            });

            document.body.appendChild(bookmarkBtn);
        }

        // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–≥–ª–∞–≤–ª–µ–Ω–∏—è
        initDisplay() {
            const bookmarks = this.getBookmarks();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–∫–ª–∞–¥–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —è–∑—ã–∫–∞
            const currentLang = window.location.pathname.split('/')[1] || 'ru';
            const currentLangBookmarks = {};

            Object.keys(bookmarks).forEach(path => {
                if (path.startsWith(`/${currentLang}/`)) {
                    currentLangBookmarks[path] = bookmarks[path];
                }
            });

            if (Object.keys(currentLangBookmarks).length === 0) return;

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–∫–ª–∞–¥–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const sortedBookmarks = Object.values(currentLangBookmarks).sort((a, b) => b.timestamp - a.timestamp);

            const container = document.querySelector('h1')?.parentElement;
            if (!container) return;

            // –°–æ–∑–¥–∞–µ–º –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º DOM-—ç–ª–µ–º–µ–Ω—Ç —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏
            const bookmarksContainer = document.createElement('div');
            bookmarksContainer.className = 'bg-accent/20 border-l-4 border-accent p-4 my-6';

            const titleElement = document.createElement('h3');
            titleElement.className = 'font-bold text-lg mb-2';
            titleElement.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ';
            bookmarksContainer.appendChild(titleElement);

            sortedBookmarks.forEach(bookmark => {
                const bookmarkElement = document.createElement('div');
                bookmarkElement.className = 'mb-2 last:mb-0';
                bookmarkElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <a href="${bookmark.path}" class="text-secondary hover:text-primary font-semibold flex-grow">
                            ${bookmark.title}
                        </a>
                        <button class="remove-bookmark-btn text-red-500 hover:text-red-700 text-sm ml-2"
                                data-path="${bookmark.path}" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–ª–∞–¥–∫—É">
                            ‚úï
                        </button>
                    </div>
                    <p class="text-sm text-ink/70 mt-1">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –ø–æ–∑–∏—Ü–∏–∏ ${Math.round(bookmark.scroll)}px</p>
                `;
                bookmarksContainer.appendChild(bookmarkElement);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–ª–∞–¥–æ–∫
            bookmarksContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-bookmark-btn')) {
                    const path = e.target.getAttribute('data-path');
                    this.removeBookmark(path);
                    e.target.closest('div').remove(); // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
                }
            });

            // –í—Å—Ç–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ H1
            container.querySelector('h1')?.insertAdjacentElement('afterend', bookmarksContainer);
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–ª–∞–¥–∫–∏
        removeBookmark(path) {
            const bookmarks = this.getBookmarks();
            delete bookmarks[path];
            localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarks));
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞—à –∫–ª–∞—Å—Å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('astro:page-load', () => {
        new ReadingProgress();
    });
</script>
